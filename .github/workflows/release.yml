name: Release Cfer
on:
  workflow_dispatch:
    inputs:
      release_type:
        type: choice
        description: Type of release to run
        required: true
        options:
          - major
          - minor
          - patch
          - pre
jobs:
  Publish:
    runs-on: ubuntu-latest
    permissions:
      package: write
      contents: read
    steps:
      - uses: actions/checkout@v3
      - uses: ruby/setup-ruby@v1
        with:
          ruby-version: 3.1
          bundler-cache: true
      - run: bump
      - run: bundle install
      - name: Publish to RubyGems
        run: |
          mkdir -p $HOME/.gem
          touch $HOME/.gem/credentials
          chmod 0600 $HOME/.gem/credentials
          printf -- "---\n:rubygems_api_key: ${GEM_HOST_API_KEY}\n" > $HOME/.gem/credentials
          gem build *.gemspec
          echo gem push *.gem
        env:
          GEM_HOST_API_KEY: "${{secrets.RUBYGEMS_API_KEY}}"
      - name: Commit build artifacts (dist, devdist, docs, coverage)
        run: |
          git config --global user.name "${{ env.CI_COMMIT_AUTHOR }}"
          git config --global user.email "username@users.noreply.github.com"
          git commit -a -m "${{ env.CI_COMMIT_MESSAGE }}"
          git tag "v${bump current}"
          git push --tags
